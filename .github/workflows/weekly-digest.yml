name: Weekly Vedic Digest

on:
  schedule:
    - cron: '0 13 * * 0'  # Every Sunday 8am EST (13:00 UTC)
  workflow_dispatch:        # Manual trigger via GitHub UI

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLACK_MEMBER_ID: ${{ secrets.SLACK_MEMBER_ID }}
  SLACK_MENTION: ${{ secrets.SLACK_MENTION }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # so we can push dashboard data back to the repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Verify MLflow is reachable
        run: curl -sf "$MLFLOW_TRACKING_URI/health" || echo "::warning::MLflow unreachable â€” runs will not be tracked"

      - name: Cache verse data
        uses: actions/cache@v4
        with:
          path: skills/sanskrit-wisdom/data
          key: verse-data-v1

      - name: Ingest verses (first run only)
        if: ${{ !hashFiles('skills/sanskrit-wisdom/data/qdrant_store/meta.json') }}
        run: python skills/sanskrit-wisdom/scripts/ingest.py

      - name: Generate weekly digest
        run: python scripts/weekly_notification.py

      - name: Send to Slack
        run: python scripts/slack_notify.py

      - name: Export dashboard data
        run: |
          python scripts/export_mlflow_runs.py
          python scripts/export_to_sqlite.py

      - name: Commit and push dashboard data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dashboard/data/
          git diff --staged --quiet || (git commit -m "chore: update dashboard data from weekly digest" && git push)

  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: notify
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      - name: Upload dashboard artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dashboard

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
